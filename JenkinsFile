pipeline {
    agent any

    environment {
        DOCKER_HUB_CREDENTIALS = credentials('dockerhub-credentials-id')
        DOCKER_HUB_REPO = 'gv2002'
        KUBECONFIG = credentials('kubeconfig-credentials-id')
    }

    stages {
        stage('Build Docker Images') {
            steps {
                script {
                    def services = [
                        './Backend/gateway',
                        './Backend/OutputMonitor',
                        './Backend/price_monitor',
                        './Backend/SignUp',
                        './Backend/stock_ingestion',
                        './Backend/user_activity',
                        './Frontend_nw'
                    ]
                    for (service in services) {
                        dir(service) {
                            if (!service.endsWith('Frontend_nw')) {
                                sh 'mvn clean package -DskipTests'
                            }
                            def imageName = "${DOCKER_HUB_REPO}/${service.split('/').last().toLowerCase()}"
                            if (service.endsWith('Frontend_nw')) {
                                sh "docker build -t ${imageName}:latest ."
                            } else {
                                sh "docker build -t ${imageName}:latest ."
                            }
                        }
                    }
                }
            }
        }

        stage('Push Docker Images') {
            steps {
                script {
                    def services = [
                        './Backend/gateway',
                        './Backend/OutputMonitor',
                        './Backend/price_monitor',
                        './Backend/SignUp',
                        './Backend/stock_ingestion',
                        './Backend/user_activity',
                        './Frontend_nw'
                    ]

                    for (service in services) {
                        def imageName = "${DOCKER_HUB_REPO}/${service.split('/').last().toLowerCase()}"
                        sh "echo ${DOCKER_HUB_CREDENTIALS_PSW} | docker login -u ${DOCKER_HUB_CREDENTIALS_USR} --password-stdin"
                        sh "docker push ${imageName}:latest"
                    }
                }
            }
        }

        stage('Deploy MySQL') {
            steps {
                script {
                    sh 'kubectl apply -f mysql-statefulset.yaml'
                    sh 'kubectl rollout status statefulset/mysql --timeout=120s || exit 1'
                    echo "MySQL deployment completed"
                }
            }
        }

        stage('Deploy Fixed IP ConfigMap') {
            steps {
                script {
                    writeFile file: "fixed-ips.yaml", text: '''
apiVersion: v1
kind: ConfigMap
metadata:
  name: service-ips
data:
  gateway-ip: "10.100.0.10"
  outputmonitor-ip: "10.100.0.11"
  price-monitor-ip: "10.100.0.12"
  signup-ip: "10.100.0.13"
  stock-ingestion-ip: "10.100.0.14"
  frontend-ip: "10.100.0.15"
  mysql-ip: "10.100.0.16"
  user-activity-ip: "10.100.0.17"
  prometheus-ip: "10.100.0.20"
  grafana-ip: "10.100.0.21"
  loki-ip: "10.100.0.22"
'''
                    sh "kubectl apply -f fixed-ips.yaml"
                }
            }
        }
        
        stage('Deploy Stock Ingestion') {
            steps {
                script {
                    def service = 'stock_ingestion'
                    def port = 8090
                    def k8sName = service.replaceAll('_', '-').toLowerCase()
                    def serviceType = 'ClusterIP'
                    def servicePort = 80
                    def targetPort = port
                    def ipKey = k8sName + '-ip'
                    def fixedIp = '10.100.0.14' // stock-ingestion-ip
                    
                    def statefulSetYaml = """\
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: ${k8sName}
spec:
  serviceName: "${k8sName}-service"
  replicas: 1
  selector:
    matchLabels:
      app: ${k8sName}
  template:
    metadata:
      labels:
        app: ${k8sName}
    spec:
      containers:
      - name: ${k8sName}
        image: ${DOCKER_HUB_REPO}/${service}:latest
        ports:
        - containerPort: ${port}
---
apiVersion: v1
kind: Service
metadata:
  name: ${k8sName}-service
spec:
  selector:
    app: ${k8sName}
  ports:
  - protocol: TCP
    port: ${servicePort}
    targetPort: ${targetPort}
  type: ${serviceType}
  clusterIP: ${fixedIp}
"""
                    writeFile file: "${k8sName}-statefulset.yaml", text: statefulSetYaml
                    sh "kubectl apply -f ${k8sName}-statefulset.yaml"
                    sh "kubectl rollout status statefulset/${k8sName} --timeout=120s || exit 1"
                    echo "Stock Ingestion deployment completed"
                }
            }
        }

        stage('Deploy Remaining Services') {
            steps {
                script {
                    def servicePorts = [
                        'gateway'        : 8085,
                        'outputmonitor'  : 9000,
                        'price_monitor'  : 8091,
                        'signup'         : 9010,
                        'user_activity'  : 9020,
                        'frontend_nw'    : 5173
                    ]
                    
                    // Hard-code IPs instead of reading from configmap
                    def serviceIps = [
                        'gateway-ip': '10.100.0.10',
                        'outputmonitor-ip': '10.100.0.11',
                        'price-monitor-ip': '10.100.0.12',
                        'signup-ip': '10.100.0.13',
                        'frontend-ip': '10.100.0.15',
                        'user-activity-ip': '10.100.0.17'
                    ]
                    
                    for (service in servicePorts.keySet()) {
                        def port = servicePorts[service]
                        def k8sName = service.replaceAll('_', '-').toLowerCase()
                        def isFrontend = (k8sName == 'frontend-nw')
                        def serviceType = isFrontend ? 'NodePort' : 'ClusterIP'
                        def servicePort = isFrontend ? 30080 : 80
                        def targetPort = isFrontend ? 80 : port
                        
                        // Determine the fixed IP based on service name
                        def ipKey = k8sName.replaceAll('-nw', '') + '-ip'
                        def fixedIp = serviceIps[ipKey]
                        
                        def statefulSetYaml = """\
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: ${k8sName}
spec:
  serviceName: "${k8sName}-service"
  replicas: 1
  selector:
    matchLabels:
      app: ${k8sName}
  template:
    metadata:
      labels:
        app: ${k8sName}
    spec:
      containers:
      - name: ${k8sName}
        image: ${DOCKER_HUB_REPO}/${service}:latest
        ports:
        - containerPort: ${port}
---
apiVersion: v1
kind: Service
metadata:
  name: ${k8sName}-service
spec:
  selector:
    app: ${k8sName}
  ports:
  - protocol: TCP
    port: ${servicePort}
    targetPort: ${targetPort}
  type: ${serviceType}
  clusterIP: ${fixedIp}
"""
                        writeFile file: "${k8sName}-statefulset.yaml", text: statefulSetYaml
                        sh "kubectl apply -f ${k8sName}-statefulset.yaml"
                    }
                }
            }
        }

        stage('Deploy Monitoring Stack') {
            steps {
                script {
                    // Prometheus deployment
                    def prometheusYaml = '''
apiVersion: apps/v1
kind: Deployment
metadata:
  name: prometheus
spec:
  replicas: 1
  selector:
    matchLabels:
      app: prometheus
  template:
    metadata:
      labels:
        app: prometheus
    spec:
      containers:
      - name: prometheus
        image: prom/prometheus:latest
        ports:
        - containerPort: 9090
        volumeMounts:
        - name: prometheus-config
          mountPath: /etc/prometheus/
      volumes:
      - name: prometheus-config
        configMap:
          name: prometheus-config
---
apiVersion: v1
kind: Service
metadata:
  name: prometheus-service
spec:
  selector:
    app: prometheus
  ports:
  - port: 9090
    targetPort: 9090
    nodePort: 30090
  type: NodePort
  clusterIP: "10.100.0.20"
'''
                    
                    // Prometheus configuration
                    def prometheusConfigYaml = '''
apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
    scrape_configs:
      - job_name: 'gateway'
        metrics_path: '/actuator/prometheus'
        static_configs:
          - targets: ['gateway-service:80']
            labels:
              service: gateway
              
      - job_name: 'outputmonitor'
        metrics_path: '/outputmonitor/actuator/prometheus'
        static_configs:
          - targets: ['gateway-service:80']
            labels:
              service: outputmonitor
              
      - job_name: 'price-monitor'
        metrics_path: '/price-monitor/actuator/prometheus'
        static_configs:
          - targets: ['gateway-service:80']
            labels:
              service: price-monitor
              
      - job_name: 'signup'
        metrics_path: '/signup/actuator/prometheus'
        static_configs:
          - targets: ['gateway-service:80']
            labels:
              service: signup
              
      - job_name: 'stock-ingestion'
        metrics_path: '/stock-ingestion/actuator/prometheus'
        static_configs:
          - targets: ['gateway-service:80']
            labels:
              service: stock-ingestion
              
      - job_name: 'user-activity'
        metrics_path: '/user-activity/actuator/prometheus'
        static_configs:
          - targets: ['gateway-service:80']
            labels:
              service: user-activity
              
      - job_name: 'prometheus'
        metrics_path: '/metrics'
        static_configs:
          - targets: ['localhost:9090']
'''
                    // Grafana deployment
                    def grafanaYaml = '''
apiVersion: apps/v1
kind: Deployment
metadata:
  name: grafana
spec:
  replicas: 1
  selector:
    matchLabels:
      app: grafana
  template:
    metadata:
      labels:
        app: grafana
    spec:
      containers:
      - name: grafana
        image: grafana/grafana:latest
        ports:
        - containerPort: 3000
        env:
        - name: GF_SECURITY_ADMIN_USER
          value: "admin"
        - name: GF_SECURITY_ADMIN_PASSWORD
          value: "admin"
        - name: GF_INSTALL_PLUGINS
          value: "grafana-clock-panel,grafana-simple-json-datasource,grafana-piechart-panel"
        volumeMounts:
        - name: grafana-datasources
          mountPath: /etc/grafana/provisioning/datasources
      volumes:
      - name: grafana-datasources
        configMap:
          name: grafana-datasources
---
apiVersion: v1
kind: Service
metadata:
  name: grafana-service
spec:
  selector:
    app: grafana
  ports:
  - port: 3000
    targetPort: 3000
    nodePort: 30300
  type: NodePort
  clusterIP: "10.100.0.21"
'''

                    // Grafana datasources configuration
                    def grafanaDatasourcesYaml = '''
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-datasources
data:
  datasources.yaml: |
    apiVersion: 1
    datasources:
    - name: Prometheus
      type: prometheus
      access: proxy
      url: http://prometheus-service:9090
      isDefault: true
    - name: Loki
      type: loki
      access: proxy
      url: http://loki-service:3100
'''

                    // Loki deployment
                    def lokiYaml = '''
apiVersion: apps/v1
kind: Deployment
metadata:
  name: loki
spec:
  replicas: 1
  selector:
    matchLabels:
      app: loki
  template:
    metadata:
      labels:
        app: loki
    spec:
      containers:
      - name: loki
        image: grafana/loki:latest
        ports:
        - containerPort: 3100
        command:
        - /usr/bin/loki
        - -config.file=/etc/loki/local-config.yaml
---
apiVersion: v1
kind: Service
metadata:
  name: loki-service
spec:
  selector:
    app: loki
  ports:
  - port: 3100
    targetPort: 3100
    nodePort: 30100
  type: NodePort
  clusterIP: "10.100.0.22"
'''

                    // Promtail for log collection
                    def promtailYaml = '''
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: promtail
spec:
  selector:
    matchLabels:
      app: promtail
  template:
    metadata:
      labels:
        app: promtail
    spec:
      containers:
      - name: promtail
        image: grafana/promtail:latest
        args:
        - -config.file=/etc/promtail/promtail-config.yaml
        volumeMounts:
        - name: promtail-config
          mountPath: /etc/promtail
        - name: containers
          mountPath: /var/log/containers
        - name: pods
          mountPath: /var/log/pods
      volumes:
      - name: promtail-config
        configMap:
          name: promtail-config
      - name: containers
        hostPath:
          path: /var/log/containers
      - name: pods
        hostPath:
          path: /var/log/pods
'''

                    // Promtail configuration
                    def promtailConfigYaml = '''
apiVersion: v1
kind: ConfigMap
metadata:
  name: promtail-config
data:
  promtail-config.yaml: |
    server:
      http_listen_port: 9080
    positions:
      filename: /tmp/positions.yaml
    clients:
      - url: http://loki-service:3100/loki/api/v1/push

    scrape_configs:
    - job_name: kubernetes-pods
      kubernetes_sd_configs:
      - role: pod
      # add stages you need (docker, json, etc)
      pipeline_stages:
        - docker: {}
      # now extract k8s labels into Loki labels
      relabel_configs:
        - source_labels: [__meta_kubernetes_pod_label_app]
          target_label: app
        - source_labels: [__meta_kubernetes_namespace]
          target_label: namespace
        - source_labels: [__meta_kubernetes_pod_container_name]
          target_label: container
'''

                    // Write and apply all configurations
                    writeFile file: "prometheus.yaml", text: prometheusYaml
                    writeFile file: "prometheus-config.yaml", text: prometheusConfigYaml
                    writeFile file: "grafana.yaml", text: grafanaYaml
                    writeFile file: "grafana-datasources.yaml", text: grafanaDatasourcesYaml
                    writeFile file: "loki.yaml", text: lokiYaml
                    writeFile file: "promtail.yaml", text: promtailYaml
                    writeFile file: "promtail-config.yaml", text: promtailConfigYaml
                    
                    // Apply configurations
                    sh "kubectl apply -f prometheus-config.yaml"
                    sh "kubectl apply -f prometheus.yaml"
                    sh "kubectl apply -f grafana-datasources.yaml"
                    sh "kubectl apply -f grafana.yaml"
                    sh "kubectl apply -f loki.yaml"
                    sh "kubectl apply -f promtail-config.yaml"
                    sh "kubectl apply -f promtail.yaml"
                    
                    echo "Monitoring stack deployment completed"
                }
            }
        }
    }

    post {
        always {
            cleanWs()
        }
    }
}



